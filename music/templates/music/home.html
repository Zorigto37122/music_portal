{% extends 'music/base.html' %}

{% block content %}
<section style="margin-bottom: 60px; text-align: center; padding: 60px 0;">
    <h1
        style="font-size: 3.5rem; margin-bottom: 20px; background: linear-gradient(to right, #fff, #a5b4fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
        Откройте свой звук
    </h1>
    <p style="font-size: 1.2rem; opacity: 0.8; max-width: 600px; margin: 0 auto 30px;">
        Слушайте последние хиты, исследуйте новые жанры и поддерживайте своих любимых артистов в высоком качестве.
    </p>
    <form method="get" action="{% url 'music:home' %}" style="position: relative; width: 100%; max-width: 500px; margin: 0 auto;">
        <input type="text" name="q" placeholder="Поиск исполнителей, альбомов или треков..." value="{{ request.GET.q }}"
            style="width: 100%; padding: 15px 25px; padding-right: 50px; border-radius: 30px; border: none; background: rgba(255,255,255,0.1); color: white; backdrop-filter: blur(5px); outline: none;">
        <button type="submit" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); background: none; border: none; color: white; cursor: pointer; opacity: 0.7;">
            <i class="fas fa-search"></i>
        </button>
    </form>
</section>

{% if is_search and search_compositions %}
<section style="margin-bottom: 50px;">
    <h2 class="section-title">Результаты поиска: Композиции</h2>
    <div class="glass-card" style="padding: 0;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left;">
                    <th style="padding: 15px 20px; width: 50px;">#</th>
                    <th style="padding: 15px 20px;">Название</th>
                    <th style="padding: 15px 20px;">Исполнитель</th>
                    <th style="padding: 15px 20px;">Альбом</th>
                    <th style="padding: 15px 20px; width: 150px;"></th>
                </tr>
            </thead>
            <tbody>
                {% for track in search_compositions %}
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 15px 20px; opacity: 0.7;">{{ forloop.counter }}</td>
                    <td style="padding: 15px 20px; font-weight: 600;">{{ track.title }}</td>
                    <td style="padding: 15px 20px;">
                        <a href="{% url 'music:performer_detail' track.album.performer.pk %}" style="color: white; text-decoration: none;">
                            {{ track.album.performer.name }}
                        </a>
                    </td>
                    <td style="padding: 15px 20px;">
                        <a href="{% url 'music:album_detail' track.album.pk %}" style="color: white; text-decoration: none; opacity: 0.7;">
                            {{ track.album.title }}
                        </a>
                    </td>
                    <td style="padding: 15px 20px;">
                        <div style="display: flex; justify-content: flex-end; align-items: center; gap: 15px;">
                            <button onclick="playTrack('{{ track.audio_file.url }}', '{{ track.title }}', '{{ track.album.performer.name }}', {{ track.pk }})"
                                style="background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem;">
                                <i class="fas fa-play"></i>
                            </button>
                            {% if user.is_authenticated %}
                            <button onclick="interact('like_composition', {{ track.pk }}, this)"
                                style="background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem;">
                                <i class="far fa-heart"></i>
                            </button>
                            <a href="{% url 'music:download_composition' track.pk %}"
                                style="color: white; text-decoration: none; font-size: 1.2rem;">
                                <i class="fas fa-download"></i>
                            </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endif %}

<section style="margin-bottom: 50px;">
    <h2 class="section-title">{% if is_search %}Результаты поиска: Альбомы{% else %}Популярные Альбомы{% endif %}</h2>
    <div class="grid">
        {% for album in featured_albums %}
        <div class="glass-card" style="padding: 15px;">
            <div
                style="position: relative; margin-bottom: 15px; border-radius: 8px; overflow: hidden; aspect-ratio: 1/1;">
                {% if album.cover_image %}
                <img src="{{ album.cover_image.url }}" alt="{{ album.title }}"
                    style="width: 100%; height: 100%; object-fit: cover;">
                {% else %}
                <div
                    style="width: 100%; height: 100%; background: #333; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-music" style="font-size: 3rem; opacity: 0.5;"></i>
                </div>
                {% endif %}
                <a href="{% url 'music:album_detail' album.pk %}"
                    style="position: absolute; inset: 0; background: rgba(0,0,0,0.4); opacity: 0; transition: opacity 0.3s; display: flex; align-items: center; justify-content: center; text-decoration: none;">
                    <i class="fas fa-play-circle" style="font-size: 3rem; color: white;"></i>
                </a>
            </div>
            <h3 style="font-size: 1.1rem; margin-bottom: 5px;">{{ album.title }}</h3>
            <p style="font-size: 0.9rem; opacity: 0.7;">{{ album.performer.name }}</p>
        </div>
        {% empty %}
        <p>Альбомы не найдены.</p>
        {% endfor %}
    </div>
</section>

<section>
    <h2 class="section-title">{% if is_search %}Результаты поиска: Исполнители{% else %}Топ Исполнители{% endif %}</h2>
    <div class="grid" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">
        {% for performer in top_performers %}
        <div class="glass-card" style="padding: 20px; text-align: center;">
            <div
                style="width: 100px; height: 100px; border-radius: 50%; overflow: hidden; margin: 0 auto 15px; border: 2px solid var(--accent);">
                {% if performer.photo %}
                <img src="{{ performer.photo.url }}" alt="{{ performer.name }}"
                    style="width: 100%; height: 100%; object-fit: cover;">
                {% else %}
                <div
                    style="width: 100%; height: 100%; background: #333; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-user" style="font-size: 2rem; opacity: 0.5;"></i>
                </div>
                {% endif %}
            </div>
            <h3 style="font-size: 1.1rem; margin-bottom: 5px;">
                <a href="{% url 'music:performer_detail' performer.pk %}"
                    style="color: white; text-decoration: none;">{{ performer.name }}</a>
            </h3>
            <p style="font-size: 0.8rem; opacity: 0.7;">{{ performer.get_type_display }}</p>
        </div>
        {% empty %}
        <p>Исполнители не найдены.</p>
        {% endfor %}
    </div>
</section>

{% if is_search %}
<script>
    function interact(type, id, btn) {
        fetch(`/interact/${type}/${id}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(response => response.json())
            .then(data => {
                if (data.status === 'added') {
                    if (btn) {
                        const icon = btn.querySelector('i');
                        icon.classList.remove('far');
                        icon.classList.add('fas');
                        icon.style.color = 'var(--accent)';
                    }
                } else if (data.status === 'removed') {
                    if (btn) {
                        const icon = btn.querySelector('i');
                        icon.classList.remove('fas');
                        icon.classList.add('far');
                        icon.style.color = 'white';
                    }
                }
            });
    }
</script>
{% endif %}
{% endblock %}